name: Pipeline

on:
  push:
    branches: ["*"]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: dudin-george/cu-x5-bootcamp

jobs:
  # ============ LINT ============
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Lint Python
        run: |
          pip install ruff
          echo "Linting core_api..."
          ruff check services/core_api/app/ || true
          for svc in candidate_bot hm_bot worker; do
            echo "Linting $svc..."
            ruff check services/$svc/src/ || true
          done

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Lint Frontend
        run: |
          cd services/recruiter_web
          npm ci || npm install
          npm run lint

      - name: Lint Helm
        run: |
          helm dependency update infra/helm/charts/app
          helm lint infra/helm/charts/app

  # ============ BUILD BACKEND SERVICES ============
  build:
    name: Build ${{ matrix.service }}
    needs: lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: core-api
            context: services/core_api
          - service: candidate-bot
            context: services/candidate_bot
          - service: hm-bot
            context: services/hm_bot
          - service: worker
            context: services/worker
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          command: |
            docker buildx build \
              --push \
              --tag ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:${{ github.sha }} \
              --tag ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:latest \
              --cache-from type=gha \
              --cache-to type=gha,mode=max \
              ${{ matrix.context }}

  # ============ BUILD FRONTEND (DEV) ============
  build-frontend-dev:
    name: Build Frontend (DEV)
    needs: lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push (DEV)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          command: |
            docker buildx build \
              --push \
              --build-arg VITE_ENVIRONMENT=dev \
              --build-arg VITE_API_URL=/api \
              --tag ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/recruiter-web:${{ github.sha }} \
              --tag ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/recruiter-web:latest \
              --cache-from type=gha \
              --cache-to type=gha,mode=max \
              services/recruiter_web

  # ============ BUILD FRONTEND (PROD) ============
  build-frontend-prod:
    name: Build Frontend (PROD)
    needs: lint
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push (PROD)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          command: |
            docker buildx build \
              --push \
              --build-arg VITE_ENVIRONMENT=prod \
              --build-arg VITE_ORY_SDK_URL=https://infallible-shaw-gpsjwuc0lg.projects.oryapis.com \
              --build-arg VITE_API_URL=/api \
              --tag ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/recruiter-web:${{ github.sha }}-prod \
              --tag ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/recruiter-web:latest-prod \
              --cache-from type=gha \
              --cache-to type=gha,mode=max \
              services/recruiter_web

  # ============ DEPLOY DEV ============
  deploy-dev:
    name: Deploy DEV
    needs: [build, build-frontend-dev]
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.14.0"

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Update Helm dependencies
        run: helm dependency update infra/helm/charts/app

      - name: Deploy to DEV
        run: |
          helm upgrade --install x5-app infra/helm/charts/app \
            --namespace dev --create-namespace \
            -f infra/helm/charts/app/values-dev.yaml \
            --set global.image.tag=${{ github.sha }} \
            --set core-api.secrets.databaseUrl="${{ secrets.DATABASE_URL }}" \
            --set candidate-bot.secrets.telegramBotToken="${{ secrets.TELEGRAM_BOT_TOKEN_CANDIDATE }}" \
            --set candidate-bot.secrets.webhookSecret="${{ secrets.WEBHOOK_SECRET_CANDIDATE }}" \
            --set hm-bot.secrets.telegramBotToken="${{ secrets.TELEGRAM_BOT_TOKEN_HM }}" \
            --set hm-bot.secrets.webhookSecret="${{ secrets.WEBHOOK_SECRET_HM }}" \
            --wait --timeout 10m \
            --debug

      - name: Verify deployment
        if: always()
        run: |
          echo "=== PODS ==="
          kubectl get pods -n dev -o wide
          echo ""
          echo "=== PODS STATUS ==="
          kubectl get pods -n dev -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.phase}{"\t"}{.status.containerStatuses[*].ready}{"\n"}{end}'
          echo ""
          echo "=== RECENT EVENTS ==="
          kubectl get events -n dev --sort-by='.lastTimestamp' | tail -20
          echo ""
          echo "=== INGRESS ==="
          kubectl get ingress -n dev

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== FAILED PODS LOGS ==="
          for pod in $(kubectl get pods -n dev --field-selector=status.phase!=Running -o jsonpath='{.items[*].metadata.name}'); do
            echo "--- Logs for $pod ---"
            kubectl logs $pod -n dev --all-containers=true --tail=50 || true
            echo "--- Init container logs for $pod ---"
            kubectl logs $pod -n dev -c migrations --tail=50 || true
          done

  # ============ DEPLOY PROD ============
  deploy-prod:
    name: Deploy PROD
    needs: [build, build-frontend-prod]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.14.0"

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Update Helm dependencies
        run: helm dependency update infra/helm/charts/app

      - name: Deploy to PROD
        run: |
          helm upgrade --install x5-app infra/helm/charts/app \
            --namespace prod --create-namespace \
            -f infra/helm/charts/app/values-prod.yaml \
            --set global.image.tag=${{ github.sha }} \
            --set recruiter-web.image.tag=${{ github.sha }}-prod \
            --set core-api.secrets.databaseUrl="${{ secrets.DATABASE_URL }}" \
            --set candidate-bot.secrets.telegramBotToken="${{ secrets.TELEGRAM_BOT_TOKEN_CANDIDATE }}" \
            --set candidate-bot.secrets.webhookSecret="${{ secrets.WEBHOOK_SECRET_CANDIDATE }}" \
            --set hm-bot.secrets.telegramBotToken="${{ secrets.TELEGRAM_BOT_TOKEN_HM }}" \
            --set hm-bot.secrets.webhookSecret="${{ secrets.WEBHOOK_SECRET_HM }}" \
            --wait --timeout 10m \
            --debug

      - name: Verify deployment
        if: always()
        run: |
          echo "=== PODS ==="
          kubectl get pods -n prod -o wide
          echo ""
          echo "=== PODS STATUS ==="
          kubectl get pods -n prod -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.phase}{"\t"}{.status.containerStatuses[*].ready}{"\n"}{end}'
          echo ""
          echo "=== RECENT EVENTS ==="
          kubectl get events -n prod --sort-by='.lastTimestamp' | tail -20
          echo ""
          echo "=== INGRESS ==="
          kubectl get ingress -n prod

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== FAILED PODS LOGS ==="
          for pod in $(kubectl get pods -n prod --field-selector=status.phase!=Running -o jsonpath='{.items[*].metadata.name}'); do
            echo "--- Logs for $pod ---"
            kubectl logs $pod -n prod --all-containers=true --tail=50 || true
            echo "--- Init container logs for $pod ---"
            kubectl logs $pod -n prod -c migrations --tail=50 || true
          done
