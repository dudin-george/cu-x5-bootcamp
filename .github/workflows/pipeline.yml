name: Pipeline

on:
  push:
    branches: ["*"]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: dudin-george/cu-x5-bootcamp

jobs:
  # ============ LINT ============
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Lint Python
        run: |
          pip install ruff
          for svc in core_api candidate_bot hm_bot worker; do
            echo "Linting $svc..."
            ruff check services/$svc/src/ || true
          done

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Lint Frontend
        run: |
          cd services/recruiter_web
          npm ci || npm install
          npm run lint || true

      - name: Lint Helm
        run: |
          helm dependency update infra/helm/charts/app
          helm lint infra/helm/charts/app

  # ============ BUILD ============
  build:
    name: Build ${{ matrix.service }}
    needs: lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: core-api
            context: services/core_api
          - service: candidate-bot
            context: services/candidate_bot
          - service: hm-bot
            context: services/hm_bot
          - service: worker
            context: services/worker
          - service: recruiter-web
            context: services/recruiter_web
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          command: |
            docker buildx build \
              --push \
              --tag ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:${{ github.sha }} \
              --tag ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:latest \
              --cache-from type=gha \
              --cache-to type=gha,mode=max \
              ${{ matrix.context }}

  # ============ DEPLOY DEV ============
  deploy-dev:
    name: Deploy DEV
    needs: build
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.14.0"

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Update Helm dependencies
        run: helm dependency update infra/helm/charts/app

      - name: Deploy to DEV
        run: |
          helm upgrade --install x5-app infra/helm/charts/app \
            --namespace dev --create-namespace \
            -f infra/helm/charts/app/values-dev.yaml \
            --set global.image.tag=${{ github.sha }} \
            --set candidate-bot.secrets.telegramBotToken="${{ secrets.TELEGRAM_BOT_TOKEN_CANDIDATE }}" \
            --set candidate-bot.secrets.webhookSecret="${{ secrets.WEBHOOK_SECRET_CANDIDATE }}" \
            --set hm-bot.secrets.telegramBotToken="${{ secrets.TELEGRAM_BOT_TOKEN_HM }}" \
            --set hm-bot.secrets.webhookSecret="${{ secrets.WEBHOOK_SECRET_HM }}" \
            --wait --timeout 5m

      - name: Verify deployment
        run: |
          kubectl get pods -n dev
          kubectl get ingress -n dev

  # ============ DEPLOY PROD ============
  deploy-prod:
    name: Deploy PROD
    needs: build
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.14.0"

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Update Helm dependencies
        run: helm dependency update infra/helm/charts/app

      - name: Deploy to PROD
        run: |
          helm upgrade --install x5-app infra/helm/charts/app \
            --namespace prod --create-namespace \
            -f infra/helm/charts/app/values-prod.yaml \
            --set global.image.tag=${{ github.sha }} \
            --set candidate-bot.secrets.telegramBotToken="${{ secrets.TELEGRAM_BOT_TOKEN_CANDIDATE }}" \
            --set candidate-bot.secrets.webhookSecret="${{ secrets.WEBHOOK_SECRET_CANDIDATE }}" \
            --set hm-bot.secrets.telegramBotToken="${{ secrets.TELEGRAM_BOT_TOKEN_HM }}" \
            --set hm-bot.secrets.webhookSecret="${{ secrets.WEBHOOK_SECRET_HM }}" \
            --wait --timeout 5m

      - name: Verify deployment
        run: |
          kubectl get pods -n prod
          kubectl get ingress -n prod

